<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>완대전</title>
    <meta
      name="description"
      content="완도고등학교 학생들을 위한 웹 커뮤니티 사이트입니다."
    />

    <!-- Open Graph 태그 (소셜 미디어 공유용) -->
    <meta property="og:title" content="완대전" />
    <meta
      property="og:description"
      content="완도고등학교 학생들을 위한 웹 커뮤니티 사이트입니다."
    />
    <meta property="og:image" content="https://wdj.kr/content.png" />
    <meta property="og:url" content="https://wdj.kr/" />
    <link
      rel="apple-touch-icon"
      sizes="57x57"
      href="/asset/icon/apple-icon-57x57.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="60x60"
      href="/asset/icon/apple-icon-60x60.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="72x72"
      href="/asset/icon/apple-icon-72x72.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="/asset/icon/apple-icon-76x76.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="57x57"
      href="/asset/icon/apple-icon-57x57.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="60x60"
      href="/asset/icon/apple-icon-60x60.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="72x72"
      href="/asset/icon/apple-icon-72x72.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="/asset/icon/apple-icon-76x76.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="114x114"
      href="/asset/icon/apple-icon-114x114.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="120x120"
      href="/asset/icon/apple-icon-120x120.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="144x144"
      href="/asset/icon/apple-icon-144x144.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="/asset/icon/apple-icon-152x152.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/asset/icon/apple-icon-180x180.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/asset/icon/android-icon-192x192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/asset/icon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href="/asset/icon/favicon-96x96.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/asset/icon/favicon-16x16.png"
    />
    <link rel="manifest" href="/manifest.json" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png" />
    <meta name="theme-color" content="#ffffff" />
    <link
      rel="stylesheet"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Pretendard", "sans-serif"],
            },
            colors: {
              primary: {
                50: "#E6F0FF",
                100: "#CCE0FF",
                200: "#99C2FF",
                300: "#66A3FF",
                400: "#3385FF",
                500: "#0066FF",
                600: "#0052CC",
                700: "#003D99",
                800: "#002966",
                900: "#001433",
              },
            },
          },
        },
      };
    </script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      /* 기본 모바일 메뉴 스타일 */
      #mobile-menu {
        position: fixed;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100vh;
        background-color: #2563eb;
        transition: left 0.3s ease-in-out;
        z-index: 50;
      }

      #mobile-menu.active {
        left: 0;
      }

      .mobile-menu-content {
        padding: 2rem;
        height: 100%;
        overflow-y: auto;
      }

      .mobile-menu-link {
        display: block;
        padding: 1rem;
        color: white;
        font-size: 1.125rem;
        border-radius: 0.5rem;
        transition: all 0.2s;
      }

      .mobile-menu-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .nav-link {
        padding: 0.5rem 0;
        position: relative;
        display: inline-block;
      }

      .nav-link::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: white;
        transform: scaleX(0);
        transform-origin: right;
        transition: transform 0.3s ease;
      }

      .nav-link:hover::after {
        transform: scaleX(1);
        transform-origin: left;
      }

      .nav-link.active::after {
        transform: scaleX(1);
      }

      .nav-link:hover {
        transform: translateY(-1px);
      }

      /* 투표 버튼 기본 스타일 */
      .vote-button {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.375rem 0.75rem;
        border-radius: 0.5rem;
        transition: all 0.2s;
        min-width: 70px;
        font-size: 0.875rem;
      }

      /* 투표 버튼 테이너 스타일 추가 */
      .vote-buttons {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        padding: 0 1rem;
      }

      /* 투표 버튼 태 */
      .vote-button:disabled {
        opacity: 0.7;
      }
      .vote-button.active {
        transform: scale(1.05);
      }

      /* 추천 버튼 */
      .upvote-button {
        background: linear-gradient(to right, #3b82f6, #2563eb);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
      }
      .upvote-button:hover,
      .upvote-button.active {
        background: linear-gradient(to right, #2563eb, #1d4ed8);
      }
      .upvote-button.active {
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
      }

      /* 비추천 버튼 */
      .downvote-button {
        background: linear-gradient(to right, #ef4444, #dc2626);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
      }
      .downvote-button:hover,
      .downvote-button.active {
        background: linear-gradient(to right, #dc2626, #b91c1c);
      }
      .downvote-button.active {
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
      }

      /* 아이콘 크기 정 */
      .vote-button i {
        font-size: 0.9rem;
      }

      /* 모바일 반응형 */
      @media (max-width: 640px) {
        .vote-buttons {
          flex-direction: row;
          gap: 0.5rem;
          padding: 0 0.5rem;
        }
        .vote-button {
          flex: 1;
          padding: 0.4rem 0.8rem;
          min-width: 0;
        }
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
  </head>
  <body class="bg-gray-100 font-sans">
    <header
      class="bg-gradient-to-r from-blue-600 to-blue-700 shadow-lg py-1 mb-8 fixed w-full top-0 z-50"
    >
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-3">
          <div class="flex justify-start lg:w-0 lg:flex-1">
            <a
              href="/index.html"
              class="text-2xl font-bold text-white hover:text-gray-100 transition-all duration-300 transform hover:scale-105"
            >
              완·대·전
            </a>
          </div>
          <nav class="hidden md:flex space-x-8">
            <a
              href="notice.html"
              class="nav-link group relative text-base font-medium text-white transition-all duration-300"
            >
              <span class="relative z-10">공지사항</span>
              <span
                class="absolute bottom-0 left-0 w-0 h-0.5 bg-white transition-all duration-300 group-hover:w-full"
              ></span>
            </a>
            <a
              href="community.html"
              class="nav-link group relative text-base font-medium text-white transition-all duration-300"
            >
              <span class="relative z-10">커뮤니티</span>
              <span
                class="absolute bottom-0 left-0 w-0 h-0.5 bg-white transition-all duration-300 group-hover:w-full"
              ></span>
            </a>
            <a
              href="petition.html"
              class="nav-link group relative text-base font-medium text-white transition-all duration-300"
            >
              <span class="relative z-10">청원·제안</span>
              <span
                class="absolute bottom-0 left-0 w-0 h-0.5 bg-white transition-all duration-300 group-hover:w-full"
              ></span>
            </a>
            <a
              href="utility.html"
              class="nav-link group relative text-base font-medium text-white transition-all duration-300"
            >
              <span class="relative z-10">학급 도우미</span>
              <span
                class="absolute bottom-0 left-0 w-0 h-0.5 bg-white transition-all duration-300 group-hover:w-full"
              ></span>
            </a>
            <a
              href="about.html"
              class="nav-link group relative text-base font-medium text-white transition-all duration-300"
            >
              <span class="relative z-10">소개</span>
              <span
                class="absolute bottom-0 left-0 w-0 h-0.5 bg-white transition-all duration-300 group-hover:w-full"
              ></span>
            </a>
          </nav>
          <div class="md:hidden">
            <button
              id="mobile-menu-button"
              class="rounded-lg p-2 inline-flex items-center justify-center text-white hover:bg-blue-500/50 transition-all duration-300"
              aria-label="메뉴 열기"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div id="mobile-menu" class="md:hidden">
        <div class="mobile-menu-content">
          <div class="flex justify-between items-center mb-4">
            <a href="/index.html" class="text-xl font-bold text-white"
              >완·대·전</a
            >
            <button
              id="mobile-menu-close"
              class="p-1.5 rounded-lg text-white hover:bg-blue-500/50 transition-all duration-300"
              aria-label="메뉴 닫기"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <nav class="space-y-2">
            <a href="notice.html" class="mobile-menu-link text-sm">공지사항</a>
            <a href="community.html" class="mobile-menu-link text-sm"
              >커뮤니티</a
            >
            <a href="petition.html" class="mobile-menu-link text-sm"
              >청원·제안</a
            >
            <a href="utility.html" class="mobile-menu-link text-sm"
              >학급 도우미</a
            >
            <a href="about.html" class="mobile-menu-link text-sm">소개</a>
          </nav>
        </div>
      </div>
    </header>
    <main
      class="container mx-auto px-4 sm:px-6 lg:px-8 mt-20 mb-12 sm:mt-24 sm:mb-16"
    >
      <!-- 게시글 상세 내 컨테이너 -->
      <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <!-- 게시글 헤더 -->
        <div class="p-4 sm:p-6">
          <div
            class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-3 sm:mb-4"
          >
            <h1
              class="text-xl sm:text-2xl font-bold mb-2 sm:mb-0"
              id="postTitle"
            ></h1>
            <div class="flex items-center space-x-3 text-sm text-gray-500">
              <span>
                <i class="far fa-eye"></i> <span id="viewCount">0</span>
              </span>
              <span>
                <i class="far fa-comment"></i> <span id="commentCount">0</span>
              </span>
            </div>
          </div>

          <div
            class="flex flex-col sm:flex-row sm:justify-between sm:items-center text-sm text-gray-600 border-b pb-3 sm:pb-4"
          >
            <div
              class="flex flex-col sm:flex-row sm:items-center sm:space-x-4 space-y-1 sm:space-y-0 mb-2 sm:mb-0"
            >
              <span id="authorInfo"></span>
              <span id="postDate"></span>
              <span id="ipAddress" class="text-gray-400"></span>
            </div>
            <!-- 관리자 전용 컨트롤 -->
            <div id="adminControls" class="hidden space-x-2">
              <button class="text-blue-500 hover:text-blue-700" id="viewRealIP">
                <i class="fas fa-network-wired"></i> IP 보기
              </button>
              <button
                class="text-yellow-500 hover:text-yellow-700"
                id="viewRealAuthor"
              >
                <i class="fas fa-user-secret"></i> 작성자 보기
              </button>
            </div>
          </div>

          <!-- 게시글 내용 -->
          <div
            class="py-4 sm:py-6 min-h-[150px] sm:min-h-[200px] whitespace-pre-wrap text-sm sm:text-base"
            id="postContent"
          ></div>

          <!-- 추천/비추천 버튼 -->
          <div
            class="flex justify-center space-x-4 py-6 sm:py-8 border-t vote-buttons"
          >
            <button
              id="upvoteButton"
              class="vote-button upvote-button text-sm sm:text-base"
            >
              <i class="fas fa-thumbs-up text-lg sm:text-xl"></i>
              <span class="vote-count">0</span>
              <span class="font-bold ml-1 sm:ml-2">추천</span>
            </button>
            <button
              id="downvoteButton"
              class="vote-button downvote-button text-sm sm:text-base"
            >
              <i class="fas fa-thumbs-down text-lg sm:text-xl"></i>
              <span class="vote-count">0</span>
              <span class="font-bold ml-1 sm:ml-2">비추천</span>
            </button>
          </div>
          <div class="text-center mt-2">
            <span class="text-lg font-bold" id="score">0</span>
          </div>

          <!-- 게시글 더 부분에 추가 -->
          <div class="flex justify-between items-center mt-3 sm:mt-4">
            <div class="flex space-x-2">
              <button
                onclick="history.back()"
                class="px-3 py-1.5 sm:px-4 sm:py-2 text-sm bg-gray-500 text-white rounded hover:bg-gray-600"
              >
                목록으로
              </button>
            </div>
            <div class="flex space-x-2">
              <button
                id="editPostBtn"
                class="px-3 py-1.5 sm:px-4 sm:py-2 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 hidden"
              >
                수정
              </button>
              <button
                id="deletePostBtn"
                class="px-3 py-1.5 sm:px-4 sm:py-2 text-sm bg-red-500 text-white rounded hover:bg-red-600 hidden"
              >
                삭제
              </button>
            </div>
          </div>

          <!-- 비밀번호 모달 추가 -->
          <div
            id="passwordModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center"
          >
            <div class="bg-white p-6 rounded-lg w-96">
              <h3 class="text-lg font-bold mb-4">비밀번호 확인</h3>
              <input
                type="password"
                name="postPassword"
                id="postPassword"
                class="w-full p-2 border rounded mb-4"
                placeholder="글 작성 시 입력한 비밀번호"
              />
              <div class="flex justify-end space-x-2">
                <button
                  onclick="closePasswordModal()"
                  class="px-4 py-2 bg-gray-500 text-white rounded"
                >
                  취소
                </button>
                <button
                  id="confirmPasswordBtn"
                  class="px-4 py-2 bg-blue-500 text-white rounded"
                >
                  확인
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 댓글 섹션 -->
      <div class="mt-6 sm:mt-8">
        <h3 class="text-lg sm:text-xl font-bold mb-3 sm:mb-4">댓글</h3>
        <form id="commentForm" class="mb-4 sm:mb-6">
          <textarea
            id="commentContent"
            name="commentContent"
            class="w-full px-3 py-2 text-sm sm:text-base text-gray-700 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            rows="3"
            placeholder="댓글을 입력하세요"
            required
          ></textarea>

          <!-- 익명 댓글 입력 필수 수정 -->
          <div id="anonymousCommentFields" class="hidden mt-3 space-y-3">
            <div
              class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4"
            >
              <input
                type="text"
                name="anonymousNick"
                id="anonymousNick"
                class="flex-1 px-3 py-1.5 sm:py-2 text-sm border rounded"
                placeholder="닉네임 (미입력시 ㅇㅇ)"
              />
              <input
                type="password"
                name="anonymousPassword"
                id="anonymousPassword"
                class="flex-1 px-3 py-1.5 sm:py-2 text-sm border rounded"
                placeholder="비밀번호"
              />
            </div>
            <div class="text-sm text-gray-500">
              * 익명 댓글 작성 시 비밀번호는 필수입니다.
            </div>
          </div>

          <div class="flex items-center justify-between mt-3">
            <div class="flex items-center">
              <input
                type="checkbox"
                name="isAnonymous"
                id="isAnonymous"
                class="mr-2"
              />
              <label for="isAnonymous" class="text-sm text-gray-600"
                >익명으로 작성</label
              >
            </div>
            <button
              type="submit"
              class="px-4 py-1.5 sm:py-2 text-sm bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors"
            >
              댓글 작성
            </button>
          </div>
        </form>

        <div id="commentList" class="space-y-3">
          <!-- 댓글 목록이 여기에 동으로 추됩니다 -->
        </div>
      </div>
    </main>

    <footer
      class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white py-6 md:py-10"
    >
      <div class="container mx-auto px-6 lg:px-8">
        <!-- 모바일용 푸터 -->
        <div class="md:hidden space-y-3">
          <div class="flex justify-center space-x-4">
            <a
              href="pages/notice.html"
              class="text-gray-400 hover:text-blue-400 text-sm"
              >공지사항</a
            >
            <a
              href="pages/community.html"
              class="text-gray-400 hover:text-blue-400 text-sm"
              >커뮤니티</a
            >
            <a
              href="pages/petition.html"
              class="text-gray-400 hover:text-blue-400 text-sm"
              >청원·제안</a
            >
          </div>

          <div class="text-center text-sm text-gray-400">
            <a href="mailto:sungblab@gmail.com" class="hover:text-blue-400">
              sungblab@gmail.com
            </a>
          </div>
        </div>

        <!-- 데스크톱용 푸터 -->
        <div class="hidden md:grid grid-cols-3 gap-8">
          <!-- 기존 데스크톱 푸터 내용 유지 -->
          <div class="space-y-3">
            <h3 class="text-xl font-bold text-white mb-2">완·대·전</h3>
            <p class="text-gray-400 text-sm leading-relaxed">
              완도고등학교 학생들을 위한<br />
              더 나은 학교생활을 만들어가는<br />
              온라인 커뮤니티 플랫폼
            </p>
          </div>

          <div class="space-y-3">
            <h4 class="text-lg font-semibold text-white mb-2">바로가기</h4>
            <ul class="space-y-1.5">
              <li>
                <a
                  href="pages/notice.html"
                  class="text-gray-400 hover:text-blue-400 transition-colors duration-300 text-sm"
                  >공지사항</a
                >
              </li>
              <li>
                <a
                  href="pages/community.html"
                  class="text-gray-400 hover:text-blue-400 transition-colors duration-300 text-sm"
                  >커뮤니티</a
                >
              </li>
              <li>
                <a
                  href="pages/petition.html"
                  class="text-gray-400 hover:text-blue-400 transition-colors duration-300 text-sm"
                  >청원·제안</a
                >
              </li>
              <li>
                <a
                  href="pages/utility.html"
                  class="text-gray-400 hover:text-blue-400 transition-colors duration-300 text-sm"
                  >학급 도우미</a
                >
              </li>
            </ul>
          </div>

          <div class="space-y-3">
            <h4 class="text-lg font-semibold text-white mb-2">문의 및 정책</h4>
            <div class="space-y-1.5">
              <p class="flex items-center text-gray-400 text-sm">
                <i class="fas fa-envelope mr-2"></i>
                <a
                  href="mailto:sungblab@gmail.com"
                  class="hover:text-blue-400 transition-colors duration-300"
                  >sungblab@gmail.com</a
                >
              </p>
              <p class="flex items-center text-gray-400 text-sm">
                <i class="fas fa-map-marker-alt mr-2"></i>
                전남 완도군 완도읍 개포로 134
              </p>
              <a
                href="/pages/privacy-policy.html"
                class="block text-gray-400 hover:text-blue-400 transition-colors duration-300 text-sm"
              >
                <i class="fas fa-shield-alt mr-2"></i>
                개인정보 처리방침
              </a>
            </div>
          </div>
        </div>

        <!-- 공통 하단 영역 -->
        <div class="border-t border-gray-700 mt-8 pt-6">
          <div class="flex flex-col items-center space-y-3">
            <p class="text-xs text-gray-400 text-center">
              &copy; 2024 완도고등학교 학생회. All rights reserved.
            </p>
            <div class="flex space-x-4">
              <a
                href="#"
                class="text-gray-400 hover:text-blue-400 transition-colors duration-300"
              >
              </a>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const mobileMenuButton = document.getElementById("mobile-menu-button");
        const mobileMenuClose = document.getElementById("mobile-menu-close");
        const mobileMenu = document.getElementById("mobile-menu");

        // 모바일 메뉴 열기
        mobileMenuButton.addEventListener("click", () => {
          mobileMenu.classList.add("active");
        });

        // 모바일 메뉴 닫기
        mobileMenuClose.addEventListener("click", () => {
          mobileMenu.classList.remove("active");
        });

        // 모바일 메뉴 클릭시 메뉴 닫기
        const mobileMenuLinks = document.querySelectorAll(".mobile-menu-link");
        mobileMenuLinks.forEach((link) => {
          link.addEventListener("click", () => {
            mobileMenu.classList.remove("active");
          });
        });
      });

      // 전역 변수 설정
      const API_BASE_URL =
        "https://port-0-wdj-back-lz9cd9taff85e9dc.sel4.cloudtype.app/";
      let currentUser = JSON.parse(localStorage.getItem("user"));
      let postId = new URLSearchParams(window.location.search).get("id");

      // 유틸리티 함수들
      function formatDate(date) {
        const now = new Date();
        const targetDate = new Date(date);
        const diff = now - targetDate;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (minutes < 1) return "방금 전";
        if (minutes < 60) return `${minutes}분 전`;
        if (hours < 24) return `${hours}시간 전`;
        if (days < 7) return `${days}일 전`;

        return targetDate.toLocaleDateString("ko-KR", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function formatIPAddress(ip) {
        if (!ip) return "";
        // IPv6 형식(::ffff:127.0.0.1)에서 IPv4 부분만 추출
        const ipv4Match = ip.match(/(?::(\d+\.\d+\.\d+\.\d+))$/);
        const ipv4 = ipv4Match ? ipv4Match[1] : ip;

        const parts = ipv4.split(".");
        if (parts.length !== 4) return "";
        return `${parts[0]}.${parts[1]}`;
      }

      // 게시글 관련 함수들
      async function fetchPostDetail() {
        try {
          const token = localStorage.getItem("token");
          const response = await fetch(`${API_BASE_URL}/api/posts/${postId}`, {
            headers: {
              "Content-Type": "application/json",
              Authorization: token ? `Bearer ${token}` : "",
            },
          });

          if (!response.ok) {
            throw new Error("게시글을 불러오는데 실패했습니다.");
          }

          const data = await response.json();
          displayPostDetail(data);
        } catch (error) {
          console.error("게시글 불러오기 실패:", error);
          showError("게시글을 불러오는데 실패했습니다.");
        }
      }

      function displayPostDetail(post) {
        if (!post) return;

        // 전역 변수에 게시글 데이터 저장
        window.currentPost = post;

        const elements = {
          title: document.getElementById("postTitle"),
          author: document.getElementById("authorInfo"),
          date: document.getElementById("postDate"),
          views: document.getElementById("viewCount"),
          comments: document.getElementById("commentCount"),
          content: document.getElementById("postContent"),
          upvoteBtn: document.getElementById("upvoteButton"),
          downvoteBtn: document.getElementById("downvoteButton"),
          score: document.getElementById("score"),
        };

        // 기본 정보 표시
        elements.title.textContent = post.title;
        if (elements.author) {
          elements.author.textContent = post.isAnonymous
            ? `${post.anonymousNick || "ㅇㅇ"}(${post.ipAddress || ""})`
            : post.author?.nickname || "익명";
        }

        // 나머지 정보 표시
        if (elements.date)
          elements.date.textContent = formatDate(post.createdAt);
        if (elements.views) elements.views.textContent = post.views || 0;
        if (elements.comments)
          elements.comments.textContent = post.comments?.length || 0;
        if (elements.content && post.content) {
          // Markdown 이미지 태그를 HTML img 태그로 변환
          const content = post.content.replace(
            /!\[이미지\]\((.*?)\)/g,
            '<img src="$1" class="max-w-full h-auto my-4 rounded-lg shadow-lg" alt="첨부 이미지" loading="lazy" onerror="this.onerror=null; this.src=\'/asset/icon/image-error.png\';" />'
          );

          elements.content.innerHTML = content
            .replace(/\n/g, "<br>")
            .replace(/&lt;/g, "<")
            .replace(/&gt;/g, ">")
            .replace(/&amp;/g, "&")
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, "'");
        }

        // 투표 상태 표시
        if (elements.upvoteBtn) {
          const upvoteCount = elements.upvoteBtn.querySelector(".vote-count");
          upvoteCount.textContent = post.upvoteCount || 0;
          elements.upvoteBtn.classList.toggle("active", post.hasUpvoted);
        }

        if (elements.downvoteBtn) {
          const downvoteCount =
            elements.downvoteBtn.querySelector(".vote-count");
          downvoteCount.textContent = post.downvoteCount || 0;
          elements.downvoteBtn.classList.toggle("active", post.hasDownvoted);
        }

        // 점수 표시 및 스타일 적용
        if (elements.score) {
          elements.score.textContent = post.score || 0;
          if (post.score > 0) {
            elements.score.className = "text-blue-500 font-bold";
          } else if (post.score < 0) {
            elements.score.className = "text-red-500 font-bold";
          } else {
            elements.score.className = "text-gray-500";
          }
        }

        // 베스트글 표시
        if (
          post.isBest &&
          elements.title &&
          !elements.title.textContent.startsWith("🏆")
        ) {
          elements.title.textContent = `🏆 ${elements.title.textContent}`;
        }

        setupPostButtons(post);
        if (post.comments) {
          displayComments(post.comments);
        }
      }

      // 이벤트 리스너 설정 함수 수
      function setupEventListeners() {
        // 추천/비추천 버튼
        const upvoteBtn = document.getElementById("upvoteButton");
        const downvoteBtn = document.getElementById("downvoteButton");
        if (upvoteBtn) {
          upvoteBtn.addEventListener("click", () => handleVote("up"));
        }
        if (downvoteBtn) {
          downvoteBtn.addEventListener("click", () => handleVote("down"));
        }

        // 댓글 폼
        const commentForm = document.getElementById("commentForm");
        if (commentForm) {
          commentForm.addEventListener("submit", submitComment);
        }

        // 익명 체크박스
        const isAnonymousCheckbox = document.getElementById("isAnonymous");
        const anonymousFields = document.getElementById(
          "anonymousCommentFields"
        );
        if (isAnonymousCheckbox && anonymousFields) {
          isAnonymousCheckbox.addEventListener("change", function (e) {
            anonymousFields.classList.toggle("hidden", !e.target.checked);
          });
        }

        // 목록으로 돌아가는 버튼
        const backButton = document.querySelector(
          'button[onclick="history.back()"]'
        );
        if (backButton) {
          backButton.addEventListener("click", (e) => {
            e.preventDefault();
            location.href = "community.html";
          });
        }
      }

      // 에러 표시 함수 추가
      function showError(message) {
        const contentElement = document.getElementById("postContent");
        if (contentElement) {
          contentElement.innerHTML = `
                              <div class="text-center py-8">
                                <p class="text-red-500">${message}</p>
                                <button onclick="history.back()" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded">
                                  목록으로 돌아가기
                                </button>
                              </div>
                            `;
        }
      }

      // 게시글 버튼 제어 함수 수정
      function setupPostButtons(post) {
        const editBtn = document.getElementById("editPostBtn");
        const deleteBtn = document.getElementById("deletePostBtn");

        if (!editBtn || !deleteBtn) return;

        const currentUser = JSON.parse(localStorage.getItem("user"));
        const isAdmin = currentUser && currentUser.isAdmin;

        const showButtons = () => {
          editBtn.classList.remove("hidden");
          deleteBtn.classList.remove("hidden");
        };

        if (isAdmin) {
          // 관리는 모든 게시글 수정/삭제 가능
          showButtons();
          editBtn.onclick = () =>
            (location.href = `write-post.html?id=${post._id}`);
          deleteBtn.onclick = () => deletePost();
        } else if (post.isAnonymous) {
          // 익명 게시글
          showButtons();
          editBtn.onclick = () => showPasswordModal("edit");
          deleteBtn.onclick = () => showPasswordModal("delete");
        } else if (
          currentUser &&
          post.author &&
          currentUser.id === post.author._id
        ) {
          // 자신의 게시글
          showButtons();
          editBtn.onclick = () =>
            (location.href = `write-post.html?id=${post._id}`);
          deleteBtn.onclick = () => deletePost();
        }
      }

      // 이벤트 리스너 설정
      document.addEventListener("DOMContentLoaded", function () {
        if (!postId) {
          showError("잘못된 접근입니다.");
          return;
        }

        // 댓글 폼 이트 리스너
        const commentForm = document.getElementById("commentForm");
        if (commentForm) {
          commentForm.addEventListener("submit", submitComment);
        }

        // 익명 체크박스 이벤트 리스너
        const isAnonymousCheckbox = document.getElementById("isAnonymous");
        const anonymousFields = document.getElementById(
          "anonymousCommentFields"
        );
        if (isAnonymousCheckbox && anonymousFields) {
          isAnonymousCheckbox.addEventListener("change", function (e) {
            anonymousFields.classList.toggle("hidden", !e.target.checked);
          });
        }

        setupEventListeners();
        fetchPostDetail();

        if (currentUser?.isAdmin) {
          setupAdminControls();
        }

        // 비로그인 사자 체크
        if (!localStorage.getItem("token")) {
          const isAnonymousCheckbox = document.getElementById("isAnonymous");
          const anonymousFields = document.getElementById(
            "anonymousCommentFields"
          );

          if (isAnonymousCheckbox && anonymousFields) {
            isAnonymousCheckbox.checked = true;
            isAnonymousCheckbox.disabled = true;
            anonymousFields.classList.remove("hidden");
          }
        }
      });

      // 댓글 관련 함수들 추가
      async function submitComment(e) {
        e.preventDefault();
        const content = document.getElementById("commentContent").value;
        const isAnonymous = document.getElementById("isAnonymous").checked;

        if (!content.trim()) {
          alert("댓글 내용을 입력력해주세요.");
          return;
        }

        const commentData = {
          content,
          isAnonymous,
        };

        if (isAnonymous) {
          const anonymousNick = document.getElementById("anonymousNick").value;
          const anonymousPassword =
            document.getElementById("anonymousPassword").value;

          if (!anonymousPassword) {
            alert("익명 댓글 작성 시 비밀번호는 필수입니다.");
            return;
          }

          commentData.anonymousNick = anonymousNick || "ㅇㅇ";
          commentData.anonymousPassword = anonymousPassword;
        }

        try {
          const token = localStorage.getItem("token");
          const headers = {
            "Content-Type": "application/json",
          };

          // 로인한 사용자인 경우에만 토큰 추가
          if (!isAnonymous && token) {
            headers.Authorization = `Bearer ${token}`;
          }

          const response = await fetch(
            `${API_BASE_URL}/api/posts/${postId}/comments`,
            {
              method: "POST",
              headers,
              body: JSON.stringify(commentData),
            }
          );

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || "댓글 작성에 실패했습니다.");
          }

          // 폼 초기화
          document.getElementById("commentContent").value = "";
          if (isAnonymous) {
            document.getElementById("anonymousNick").value = "";
            document.getElementById("anonymousPassword").value = "";
            document.getElementById("isAnonymous").checked = false;
            document
              .getElementById("anonymousCommentFields")
              .classList.add("hidden");
          }

          // 댓글 목록 새로고침
          fetchPostDetail();
        } catch (error) {
          alert(error.message || "댓글 작성 중 오류가 발생했습니다.");
        }
      }

      // 댓글 목록 표시 함수
      function displayComments(comments) {
        const commentList = document.getElementById("commentList");
        if (!commentList) return;

        if (!comments || comments.length === 0) {
          commentList.innerHTML = `
            <div class="text-center py-4 text-gray-500">
              첫 댓글을 작성해보세요.
            </div>
          `;
          return;
        }

        const currentUser = JSON.parse(localStorage.getItem("user"));

        commentList.innerHTML = comments
          .map((comment) => {
            const authorDisplay = comment.isAnonymous
              ? `${comment.anonymousNick || "ㅇㅇ"}${
                  comment.ipAddress ? `(${comment.ipAddress})` : ""
                }`
              : comment.author?.nickname || "익명";

            // 삭제 버튼 시 조건 수정
            const canDelete =
              currentUser?.isAdmin || // 관리자이거나
              (currentUser &&
                comment.author &&
                currentUser.id === comment.author._id) || // 자신의 댓글이거나
              comment.isAnonymous; // 익명 글인 경우

            const deleteButton = canDelete
              ? `<button class="text-red-500 hover:text-red-700" onclick="deleteComment('${comment._id}')">삭제</button>`
              : "";

            return `
              <div class="bg-gray-50 p-4 rounded-lg">
                <div class="flex justify-between items-start">
                  <div>
                    <p class="mb-2">${comment.content}</p>
                    <p class="text-sm text-gray-500">
                      <span class="font-medium">${authorDisplay}</span>
                      <span class="mx-2">|</span>
                      <span>${formatDate(comment.createdAt)}</span>
                    </p>
                  </div>
                  <div class="flex space-x-2">
                    ${deleteButton}
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      // 댓글 삭제 함수
      async function deleteComment(commentId) {
        if (!confirm("정말로 이 댓글을 삭제하시겠습니까?")) {
          return;
        }

        try {
          const headers = {
            "Content-Type": "application/json",
          };

          // 로그인한 사용자인 경우 토큰 추가
          const token = localStorage.getItem("token");
          if (token) {
            headers.Authorization = `Bearer ${token}`;
          }

          // 익명 댓글인 경우 비밀번호 입력 받기
          let password = null;
          if (!token) {
            password = prompt("댓글 작성시 입력한 비밀번호를 입력해주세요.");
            if (!password) return;
          }

          const response = await fetch(
            `${API_BASE_URL}/api/comments/${commentId}`,
            {
              method: "DELETE",
              headers,
              body: password ? JSON.stringify({ password }) : undefined,
            }
          );

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || "댓글 삭제에 실패했습니다.");
          }

          // 댓글 목록 새로고침
          fetchPostDetail();
        } catch (error) {
          alert(error.message || "댓글 삭제 중 오류가 발생했습니다.");
        }
      }

      // 익명 체크박스 이벤트 리스너 수정
      document
        .getElementById("isAnonymous")
        .addEventListener("change", function (e) {
          const anonymousFields = document.getElementById(
            "anonymousCommentFields"
          );
          const anonymousPassword =
            document.getElementById("anonymousPassword");

          anonymousFields.classList.toggle("hidden", !this.checked);

          // 익명 선택 시 비밀번호 필수 설정
          if (this.checked) {
            anonymousPassword.setAttribute("required", "required");
          } else {
            anonymousPassword.removeAttribute("required");
          }
        });

      // 추추천천/비추천 처리 함수
      async function handleVote(type) {
        const upvoteBtn = document.getElementById("upvoteButton");
        const downvoteBtn = document.getElementById("downvoteButton");
        const scoreElement = document.getElementById("score");

        try {
          upvoteBtn.disabled = true;
          downvoteBtn.disabled = true;

          const response = await fetch(
            `${API_BASE_URL}/api/posts/${postId}/vote`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ type }),
              credentials: "include",
            }
          );

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message);
          }

          // UI 업데이트
          const upvoteCount = upvoteBtn.querySelector(".vote-count");
          const downvoteCount = downvoteBtn.querySelector(".vote-count");

          upvoteCount.textContent = data.upvotes;
          downvoteCount.textContent = data.downvotes;
          scoreElement.textContent = data.score;

          // 버튼 상태 업데이트
          upvoteBtn.classList.toggle("active", type === "up");
          downvoteBtn.classList.toggle("active", type === "down");

          // 베스트글 표시 업데이트
          if (data.isBest) {
            const titleElement = document.getElementById("postTitle");
            if (titleElement && !titleElement.textContent.startsWith("🏆")) {
              titleElement.textContent = `🏆 ${titleElement.textContent}`;
            }
          }

          // 점수에 따른 상태 변경
          if (data.score > 0) {
            scoreElement.className = "text-blue-500 font-bold";
          } else if (data.score < 0) {
            scoreElement.className = "text-red-500 font-bold";
          } else {
            scoreElement.className = "text-gray-500";
          }
        } catch (error) {
          alert(error.message || "투표 처리 중 오류가 발생했습니다.");
        } finally {
          upvoteBtn.disabled = false;
          downvoteBtn.disabled = false;
        }
      }

      // 관리자 컨트롤 설정 함수 수정
      function setupAdminControls() {
        const adminControls = document.getElementById("adminControls");
        if (!adminControls) return;

        const currentUser = JSON.parse(localStorage.getItem("user"));
        if (!currentUser?.isAdmin) return;

        // 현재 게시글 데이터가 있고 익명 게시글인 경우에만 관리자 컨트롤 표시
        const post = window.currentPost;
        if (post && post.isAnonymous) {
          adminControls.classList.remove("hidden");

          // IP 보기 버튼 이벤트 리스너
          document
            .getElementById("viewRealIP")
            .addEventListener("click", async () => {
              try {
                const token = localStorage.getItem("token");
                const response = await fetch(
                  `${API_BASE_URL}/api/posts/${postId}/ip`,
                  {
                    headers: {
                      Authorization: `Bearer ${token}`,
                    },
                  }
                );

                if (!response.ok) throw new Error("IP 조회 실패");

                const data = await response.json();
                alert(`작성자 IP: ${data.ipAddress}`);
              } catch (error) {
                alert("IP 조회 중 오류가 발생했습니다.");
              }
            });

          // 작성자 정보 보기 버튼 이벤트 리스너
          document
            .getElementById("viewRealAuthor")
            .addEventListener("click", async () => {
              try {
                const token = localStorage.getItem("token");
                const response = await fetch(
                  `${API_BASE_URL}/api/posts/${postId}/author`,
                  {
                    headers: {
                      Authorization: `Bearer ${token}`,
                    },
                  }
                );

                if (!response.ok) throw new Error("작성자 정보 조회 실패");

                const data = await response.json();
                alert(
                  `작성자 정보:\n닉네임: ${data.nickname}\n아이디: ${data.username}`
                );
              } catch (error) {
                alert("작성자 정보 조회 중 오류가 발생했습니다.");
              }
            });
        }
      }

      // 비밀번호 모달 관련 함수
      let currentAction = ""; // 'edit' 또는 'delete'

      // 비밀번호 모달 열기
      function showPasswordModal(action) {
        currentAction = action;
        const modal = document.getElementById("passwordModal");
        const passwordInput = document.getElementById("postPassword");

        modal.classList.remove("hidden");
        passwordInput.value = "";
        passwordInput.focus();
      }

      // 비밀번호 모달 닫기
      function closePasswordModal() {
        const modal = document.getElementById("passwordModal");
        modal.classList.add("hidden");
        currentAction = "";
      }

      // 비비밀번호 확인 버튼 이벤트 리스너
      document
        .getElementById("confirmPasswordBtn")
        .addEventListener("click", async () => {
          const password = document.getElementById("postPassword").value;

          if (!password) {
            alert("비밀번호를 입력해주세요.");
            return;
          }

          try {
            const response = await fetch(
              `${API_BASE_URL}/api/posts/${postId}/verify-password`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ password }),
              }
            );

            if (!response.ok) {
              throw new Error("비밀번호가 일치하지 않습니다.");
            }

            // 비밀번호 확인 성공 후 작업 수행
            if (currentAction === "edit") {
              location.href = `write-post.html?id=${postId}&password=${password}`;
            } else if (currentAction === "delete") {
              await deletePost(password);
            }

            closePasswordModal();
          } catch (error) {
            alert(error.message || "비밀번호 확인 중 오류가 발생했습니다.");
          }
        });

      // 게시글 삭제 함수
      async function deletePost(password = null) {
        if (!confirm("정말로 이 게시글을 삭제하시겠습니까?")) {
          return;
        }

        try {
          const headers = {
            "Content-Type": "application/json",
          };

          // 로그인한 사용자인 경우 토큰 추가
          const token = localStorage.getItem("token");
          if (token) {
            headers.Authorization = `Bearer ${token}`;
          }

          // 비밀번호가 있는 경우 요청 본문에 포함
          const body = password ? { password } : undefined;

          const response = await fetch(`${API_BASE_URL}/api/posts/${postId}`, {
            method: "DELETE",
            headers,
            body: body ? JSON.stringify(body) : undefined,
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || "게시글 삭제에 실패했습니다.");
          }

          alert("게시글이 삭제되었습니다.");
          location.href = "community.html";
        } catch (error) {
          alert(error.message || "게시글 삭제 중 오류가 발생했습니다.");
        }
      }
    </script>
  </body>
</html>
