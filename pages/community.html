<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>완대전</title>
    <meta
      name="description"
      content="완도고등학교 학생들을 위한 웹 커뮤니티 사이트입니다."
    />

    <!-- Open Graph 태그 (소셜 미디어 공유용) -->
    <meta property="og:title" content="완대전" />
    <meta
      property="og:description"
      content="완도고등학교 학생들을 위한 웹 커뮤니티 사이트입니다."
    />
    <meta property="og:image" content="https://wdj.kr/content.png" />
    <meta property="og:url" content="https://wdj.kr/" />
    <link
      rel="apple-touch-icon"
      sizes="57x57"
      href="/asset/icon/apple-icon-57x57.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="60x60"
      href="/asset/icon/apple-icon-60x60.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="72x72"
      href="/asset/icon/apple-icon-72x72.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="/asset/icon/apple-icon-76x76.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="57x57"
      href="/asset/icon/apple-icon-57x57.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="60x60"
      href="/asset/icon/apple-icon-60x60.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="72x72"
      href="/asset/icon/apple-icon-72x72.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="/asset/icon/apple-icon-76x76.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="114x114"
      href="/asset/icon/apple-icon-114x114.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="120x120"
      href="/asset/icon/apple-icon-120x120.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="144x144"
      href="/asset/icon/apple-icon-144x144.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="/asset/icon/apple-icon-152x152.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/asset/icon/apple-icon-180x180.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/asset/icon/android-icon-192x192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/asset/icon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href="/asset/icon/favicon-96x96.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/asset/icon/favicon-16x16.png"
    />
    <link rel="manifest" href="/manifest.json" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png" />
    <meta name="theme-color" content="#ffffff" />
    <link
      rel="stylesheet"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Pretendard", "sans-serif"],
            },
            colors: {
              primary: {
                50: "#E6F0FF",
                100: "#CCE0FF",
                200: "#99C2FF",
                300: "#66A3FF",
                400: "#3385FF",
                500: "#0066FF",
                600: "#0052CC",
                700: "#003D99",
                800: "#002966",
                900: "#001433",
              },
            },
          },
        },
      };
    </script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      #mobile-menu {
        position: fixed;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100vh;
        background-color: #2563eb;
        transition: left 0.3s ease-in-out;
        z-index: 50;
      }

      #mobile-menu.active {
        left: 0;
      }

      .mobile-menu-content {
        padding: 2rem;
        height: 100%;
        overflow-y: auto;
      }

      .mobile-menu-link {
        display: block;
        padding: 1rem;
        color: white;
        font-size: 1.125rem;
        border-radius: 0.5rem;
        transition: all 0.2s;
      }

      .mobile-menu-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .nav-link {
        padding: 0.5rem 0;
        position: relative;
        display: inline-block;
      }

      .nav-link::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: white;
        transform: scaleX(0);
        transform-origin: right;
        transition: transform 0.3s ease;
      }

      .nav-link:hover::after {
        transform: scaleX(1);
        transform-origin: left;
      }

      .nav-link.active::after {
        transform: scaleX(1);
      }

      .nav-link:hover {
        transform: translateY(-1px);
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
  </head>
  <body class="bg-gray-100 font-sans">
    <header
      class="bg-gradient-to-r from-blue-600 to-blue-700 shadow-lg py-1 mb-8 fixed w-full top-0 z-50"
    >
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-3">
          <div class="flex justify-start lg:w-0 lg:flex-1">
            <a
              href="/index.html"
              class="text-2xl font-bold text-white hover:text-gray-100 transition-all duration-300 transform hover:scale-105"
            >
              완·대·전
            </a>
          </div>
          <nav class="hidden md:flex space-x-8">
            <a
              href="notice.html"
              class="nav-link group relative text-base font-medium text-white transition-all duration-300"
            >
              <span class="relative z-10">공지사항</span>
              <span
                class="absolute bottom-0 left-0 w-0 h-0.5 bg-white transition-all duration-300 group-hover:w-full"
              ></span>
            </a>
            <a
              href="community.html"
              class="nav-link group relative text-base font-medium text-white transition-all duration-300"
            >
              <span class="relative z-10">커뮤니티</span>
              <span
                class="absolute bottom-0 left-0 w-0 h-0.5 bg-white transition-all duration-300 group-hover:w-full"
              ></span>
            </a>
            <a
              href="petition.html"
              class="nav-link group relative text-base font-medium text-white transition-all duration-300"
            >
              <span class="relative z-10">청원·제안</span>
              <span
                class="absolute bottom-0 left-0 w-0 h-0.5 bg-white transition-all duration-300 group-hover:w-full"
              ></span>
            </a>
            <a
              href="utility.html"
              class="nav-link group relative text-base font-medium text-white transition-all duration-300"
            >
              <span class="relative z-10">학급 도우미</span>
              <span
                class="absolute bottom-0 left-0 w-0 h-0.5 bg-white transition-all duration-300 group-hover:w-full"
              ></span>
            </a>
            <a
              href="about.html"
              class="nav-link group relative text-base font-medium text-white transition-all duration-300"
            >
              <span class="relative z-10">소개</span>
              <span
                class="absolute bottom-0 left-0 w-0 h-0.5 bg-white transition-all duration-300 group-hover:w-full"
              ></span>
            </a>
          </nav>
          <div class="md:hidden">
            <button
              id="mobile-menu-button"
              class="rounded-lg p-2 inline-flex items-center justify-center text-white hover:bg-blue-500/50 transition-all duration-300"
              aria-label="메뉴 열기"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div id="mobile-menu" class="md:hidden">
        <div class="mobile-menu-content">
          <div class="flex justify-between items-center mb-4">
            <a href="/index.html" class="text-xl font-bold text-white"
              >완·대·전</a
            >
            <button
              id="mobile-menu-close"
              class="p-1.5 rounded-lg text-white hover:bg-blue-500/50 transition-all duration-300"
              aria-label="메뉴 닫기"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <nav class="space-y-2">
            <a href="notice.html" class="mobile-menu-link text-sm">공지사항</a>
            <a href="community.html" class="mobile-menu-link text-sm"
              >커뮤니티</a
            >
            <a href="petition.html" class="mobile-menu-link text-sm"
              >청원·제안</a
            >
            <a href="utility.html" class="mobile-menu-link text-sm"
              >학급 도우미</a
            >
            <a href="about.html" class="mobile-menu-link text-sm">소개</a>
          </nav>
        </div>
      </div>
    </header>

    <main class="w-full sm:container mx-auto mt-24 mb-16 px-4 sm:px-8">
      <div class="mb-4 sm:mb-8">
        <div class="flex justify-between items-center mb-3 sm:mb-6">
          <h1 class="text-xl sm:text-3xl font-bold">익명 게시판</h1>
        </div>
        <form id="searchForm" class="flex flex-col sm:flex-row gap-2 sm:gap-4">
          <div class="flex-1 relative">
            <input
              type="text"
              id="searchInput"
              placeholder="검색어를 입력하세요"
              class="w-full p-2 border rounded focus:outline-none focus:border-blue-500 text-sm sm:text-base pr-12"
            />
            <button
              type="submit"
              class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-blue-500 transition-colors"
            >
              <i class="fas fa-search text-lg"></i>
            </button>
          </div>
          <div class="sm:w-32">
            <select
              id="searchType"
              class="w-full p-2 border rounded focus:outline-none focus:border-blue-500 text-sm sm:text-base"
            >
              <option value="title">제목</option>
              <option value="author">글쓴이</option>
            </select>
          </div>
        </form>
      </div>

      <!-- 정렬 옵션 설정 및 글쓰기 버튼 섹션 수정 -->
      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2 sm:gap-0"
      >
        <!-- 왼쪽 옵션들 -->
        <div class="flex items-center justify-between w-full sm:w-auto">
          <div class="flex items-center space-x-2">
            <select
              id="sortOption"
              class="border rounded px-2 py-1 text-xs sm:text-sm focus:outline-none focus:border-blue-500"
              onchange="handleSort(this.value)"
            >
              <option value="latest">최신순</option>
              <option value="oldest">오래된순</option>
              <option value="best">추천순</option>
              <option value="views">조회순</option>
            </select>

            <select
              id="postsPerPage"
              class="border rounded px-2 py-1 text-xs sm:text-sm focus:outline-none focus:border-blue-500"
            >
              <option value="15">15개</option>
              <option value="30">30개</option>
              <option value="50">50개</option>
            </select>

            <!-- 총 게시글 수를 같은 줄에 배치 -->
            <span class="text-xs sm:text-sm text-gray-600 ml-2">
              총 <span id="totalPosts" class="font-semibold">0</span>개의 글
            </span>
          </div>
        </div>

        <!-- 글쓰기 버튼을 PC에서는 오른쪽, 모바일에서는 아래에 배치 -->
        <button
          id="writePostBtn"
          class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white px-4 py-1.5 rounded-lg font-semibold transition-colors text-xs sm:text-sm ml-auto"
        >
          글쓰기
        </button>
      </div>

      <!-- 베스트글과 일반 게시글 사이 간격 줄이기 -->
      <div id="bestPosts" class="mb-2 sm:mb-4">
        <h2
          class="text-lg sm:text-2xl font-bold mb-3 sm:mb-6 flex items-center px-2"
        >
          <span class="text-xl sm:text-3xl mr-2">🏆</span> 주간 베스트
        </h2>
        <div class="space-y-3 sm:space-y-6" id="bestPostsList">
          <!-- 베스트 게시글이 여기에 동적으로 추가됩니다 -->
        </div>

        <!-- 구분선 간격 줄이기 -->
        <div class="relative mt-2 sm:mt-4 mb-2 sm:mb-4">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-gray-300"></div>
          </div>
          <div class="relative flex justify-center">
            <span class="bg-gray-100 px-3 text-xs sm:text-sm text-gray-500"
              >일반 게시글</span
            >
          </div>
        </div>
      </div>

      <!-- 게시글 목록 -->
      <div id="postList" class="space-y-2 sm:space-y-4">
        <!-- 게시글이 여기에 동적으로 추가됩니다 -->
      </div>

      <!-- 페이지네이션 -->
      <div
        id="pagination"
        class="mt-10 flex justify-center space-x-3 sm:space-x-2"
      >
        <!-- 페이지 버튼이 여기에 동적으로 추가됩니다 -->
      </div>
    </main>

    <!-- 글쓰기 모달 수정 -->
    <div
      id="writePostModal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden"
    >
      <div class="bg-white p-6 rounded-lg w-full max-w-lg">
        <h2 class="text-2xl font-bold mb-4">글쓰기</h2>
        <form id="writePostForm">
          <input
            type="text"
            id="postTitle"
            placeholder="제목"
            class="w-full p-2 mb-4 border rounded"
            required
          />
          <textarea
            id="postContent"
            placeholder="내용"
            class="w-full p-2 mb-4 border rounded h-40"
            required
          ></textarea>
          <div class="mb-4">
            <input type="checkbox" id="isAnonymous" />
            <label for="isAnonymous">익명으로 작성</label>
          </div>
          <div class="flex justify-end">
            <button
              type="button"
              id="cancelWritePost"
              class="bg-gray-300 text-black px-4 py-2 rounded mr-2"
            >
              취소
            </button>
            <button
              type="submit"
              class="bg-blue-500 text-white px-4 py-2 rounded"
            >
              작성
            </button>
          </div>
        </form>
      </div>
    </div>

    <footer
      class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white py-2 md:py-4"
    >
      <div class="container mx-auto px-6 lg:px-8">
        <!-- 모바일용 푸터 -->
        <div class="md:hidden space-y-3">
          <div class="flex justify-center space-x-4">
            <a
              href="pages/notice.html"
              class="text-gray-400 hover:text-blue-400 text-sm"
              >공지사항</a
            >
            <a
              href="pages/community.html"
              class="text-gray-400 hover:text-blue-400 text-sm"
              >커뮤니티</a
            >
            <a
              href="pages/petition.html"
              class="text-gray-400 hover:text-blue-400 text-sm"
              >청원·제안</a
            >
          </div>

          <div class="text-center text-sm text-gray-400">
            <a href="mailto:sungblab@gmail.com" class="hover:text-blue-400">
              sungblab@gmail.com
            </a>
          </div>
        </div>

        <!-- 데스크톱용 푸터 -->
        <div class="hidden md:grid grid-cols-3 gap-8">
          <!-- 기존 데스크톱 푸터 내용 유지 -->
          <div class="space-y-3">
            <h3 class="text-xl font-bold text-white mb-2">완·대·전</h3>
            <p class="text-gray-400 text-sm leading-relaxed">
              완도고등학교 학생들을 위한<br />
              더 나은 학교생활을 만들어가는<br />
              온라인 커뮤니티 플랫폼
            </p>
          </div>

          <div class="space-y-3">
            <h4 class="text-lg font-semibold text-white mb-2">바로가기</h4>
            <ul class="space-y-1.5">
              <li>
                <a
                  href="pages/notice.html"
                  class="text-gray-400 hover:text-blue-400 transition-colors duration-300 text-sm"
                  >공지사항</a
                >
              </li>
              <li>
                <a
                  href="pages/community.html"
                  class="text-gray-400 hover:text-blue-400 transition-colors duration-300 text-sm"
                  >커뮤니티</a
                >
              </li>
              <li>
                <a
                  href="pages/petition.html"
                  class="text-gray-400 hover:text-blue-400 transition-colors duration-300 text-sm"
                  >청원·제안</a
                >
              </li>
              <li>
                <a
                  href="pages/utility.html"
                  class="text-gray-400 hover:text-blue-400 transition-colors duration-300 text-sm"
                  >학급 도우미</a
                >
              </li>
            </ul>
          </div>

          <div class="space-y-3">
            <h4 class="text-lg font-semibold text-white mb-2">문의 및 정책</h4>
            <div class="space-y-1.5">
              <p class="flex items-center text-gray-400 text-sm">
                <i class="fas fa-envelope mr-2"></i>
                <a
                  href="mailto:sungblab@gmail.com"
                  class="hover:text-blue-400 transition-colors duration-300"
                  >sungblab@gmail.com</a
                >
              </p>
              <p class="flex items-center text-gray-400 text-sm">
                <i class="fas fa-map-marker-alt mr-2"></i>
                전남 완도군 완도읍 개포로 134
              </p>
              <a
                href="/pages/privacy-policy.html"
                class="block text-gray-400 hover:text-blue-400 transition-colors duration-300 text-sm"
              >
                <i class="fas fa-shield-alt mr-2"></i>
                개인정보 처리방침
              </a>
            </div>
          </div>
        </div>

        <!-- 공통 하단 영역 -->
        <div class="border-t border-gray-700 mt-8 pt-6">
          <div class="flex flex-col items-center space-y-3">
            <p class="text-xs text-gray-400 text-center">
              &copy; 2024 CodeLab. All rights reserved.
            </p>
            <div class="flex space-x-4">
              <a
                href="#"
                class="text-gray-400 hover:text-blue-400 transition-colors duration-300"
              >
              </a>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const mobileMenuButton = document.getElementById("mobile-menu-button");
        const mobileMenuClose = document.getElementById("mobile-menu-close");
        const mobileMenu = document.getElementById("mobile-menu");

        mobileMenuButton.addEventListener("click", () => {
          mobileMenu.classList.toggle("active");
        });

        mobileMenuClose.addEventListener("click", () => {
          mobileMenu.classList.remove("active");
        });
      });

      // 전역 변수 및 상수 정의
      const API_BASE_URL =
        "https://port-0-wdj-back-lz9cd9taff85e9dc.sel4.cloudtype.app";
      let postsPerPage = 15;
      let currentPage = 1;

      // API 요청 함수
      async function apiRequest(url, method = "GET", body = null) {
        const token = localStorage.getItem("token");
        const headers = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        };
        const options = {
          method,
          headers,
          body: body ? JSON.stringify(body) : null,
        };
        const response = await fetch(`${API_BASE_URL}${url}`, options);
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || "API request failed");
        }
        return response.json();
      }

      // 게시글 목록 가져오기
      async function fetchPosts() {
        try {
          const sortOption = document.getElementById("sortOption").value;
          const response = await fetch(
            `${API_BASE_URL}/api/posts?page=${currentPage}&limit=${postsPerPage}&sort=${sortOption}`
          );

          if (!response.ok) {
            throw new Error("Failed to fetch posts");
          }

          const data = await response.json();
          console.log("Fetched data:", data); // 데이터 확인용 로그
          displayPosts(data);
        } catch (error) {
          console.error("게시글 목록 불러오기 실패:", error);
          displayError("게시글을 불러오는데 실패했습니다.");
        }
      }

      // 표시 개수 변경 이벤트 리스너
      document
        .getElementById("postsPerPage")
        .addEventListener("change", function (e) {
          postsPerPage = parseInt(e.target.value);
          currentPage = 1; // 페이지 초기화
          fetchPosts(currentPage);
        });

      // 페이지네이션 업데이트 함수 수정
      function updatePagination(current, total) {
        const pagination = document.getElementById("pagination");
        let html = "";

        // 처음 페이지로 이동
        html += `<button class="px-2 py-1 rounded ${
          current === 1 ? "text-gray-400" : "text-blue-500"
        }"
              ${current === 1 ? "disabled" : ""} onclick="fetchPosts(1)">
              <i class="fas fa-angle-double-left"></i>
            </button>`;

        // 이전 페이지
        html += `<button class="px-2 py-1 rounded ${
          current === 1 ? "text-gray-400" : "text-blue-500"
        }"
              ${current === 1 ? "disabled" : ""} onclick="fetchPosts(${
          current - 1
        })">
              <i class="fas fa-angle-left"></i>
            </button>`;

        // 페이지 번호
        let startPage = Math.max(1, current - 2);
        let endPage = Math.min(total, current + 2);

        for (let i = startPage; i <= endPage; i++) {
          html += `<button class="px-3 py-1 rounded ${
            i === current ? "bg-blue-500 text-white" : "text-gray-700"
          }"
                onclick="fetchPosts(${i})">${i}</button>`;
        }

        // 다음 페이지
        html += `<button class="px-2 py-1 rounded ${
          current === total ? "text-gray-400" : "text-blue-500"
        }"
              ${current === total ? "disabled" : ""} onclick="fetchPosts(${
          current + 1
        })">
              <i class="fas fa-angle-right"></i>
            </button>`;

        // 마지막 페이지로 이동
        html += `<button class="px-2 py-1 rounded ${
          current === total ? "text-gray-400" : "text-blue-500"
        }"
              ${
                current === total ? "disabled" : ""
              } onclick="fetchPosts(${total})">
              <i class="fas fa-angle-double-right"></i>
            </button>`;

        pagination.innerHTML = html;
      }

      // formatDate 함수 수정
      function formatDate(date) {
        try {
          if (!date) return "";

          const now = new Date();
          const targetDate = new Date(date);

          // 유효하지 않은 날짜인 경우
          if (isNaN(targetDate.getTime())) {
            return "";
          }

          const timeDiff = now - targetDate;
          const seconds = Math.floor(timeDiff / 1000);
          const minutes = Math.floor(seconds / 60);
          const hours = Math.floor(minutes / 60);
          const days = Math.floor(hours / 24);

          if (seconds < 60) return "방금 전";
          if (minutes < 60) return `${minutes}분 전`;
          if (hours < 24) return `${hours}시간 전`;
          if (days < 7) return `${days}일 전`;

          return targetDate.toLocaleDateString("ko-KR", {
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        } catch (error) {
          console.error("날짜 포포맷 오류:", error);
          return "";
        }
      }

      // 게시글 표시 함수 수정
      function displayPosts(data) {
        // 베스트글 섹션
        const bestPostsContainer = document.getElementById("bestPosts");
        const bestPostsList = document.getElementById("bestPostsList");

        if (data.bestPosts && data.bestPosts.length > 0) {
          bestPostsContainer.style.display = "block";
          bestPostsList.innerHTML = data.bestPosts
            .map(
              (post) => `
                <div class="bg-yellow-50 p-3 sm:p-4 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 cursor-pointer border-l-4 border-yellow-400" 
                     onclick="location.href='post-detail.html?id=${post._id}'">
                  <div class="flex justify-between items-start">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-900">
                      🏆 ${post.title}
                      <span class="ml-2 text-xs sm:text-sm font-bold text-blue-500">+${
                        post.score || 0
                      }</span>
                    </h3>
                    <div class="flex items-center space-x-2 sm:space-x-4 text-xs sm:text-sm text-gray-500">
                      <span><i class="far fa-eye"></i> ${post.views || 0}</span>
                      <span><i class="far fa-comment"></i> ${
                        post.comments?.length || 0
                      }</span>
                      <div class="flex items-center space-x-1">
                        <span class="text-blue-500"><i class="fas fa-arrow-up"></i> ${
                          post.upvotes || 0
                        }</span>
                        <span class="text-red-500"><i class="fas fa-arrow-down"></i> ${
                          post.downvotes || 0
                        }</span>
                      </div>
                    </div>
                  </div>
                  <div class="mt-1 sm:mt-2 text-xs sm:text-sm text-gray-600">
                    <span class="font-medium">${
                      post.author?.nickname || "익명"
                    }</span>
                    ${
                      post.ipAddress
                        ? `<span class="text-gray-400">(${post.ipAddress})</span>`
                        : ""
                    }
                    <span class="mx-2">|</span>
                    <span>${formatDate(post.createdAt)}</span>
                  </div>
                </div>
              `
            )
            .join("");
        } else {
          bestPostsContainer.style.display = "none";
        }

        // 일반 게시글 목록
        const postList = document.getElementById("postList");

        // 전체 게시글이 없는 경우만 메시지 표시
        if (
          !data.posts ||
          (data.posts.length === 0 &&
            (!data.bestPosts || data.bestPosts.length === 0))
        ) {
          postList.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              게시글이 없습니다.
            </div>
          `;
          return;
        }

        // 일반 게시글 목록 표시
        if (data.posts && data.posts.length > 0) {
          postList.innerHTML = data.posts
            .map(
              (post) => `
              <div class="bg-white p-3 sm:p-4 rounded-lg shadow hover:shadow-md transition-all duration-200 cursor-pointer mb-2 sm:mb-4" 
                   onclick="location.href='post-detail.html?id=${post._id}'">
                <div class="flex justify-between items-start">
                  <h3 class="text-base sm:text-lg font-semibold text-gray-900">
                    ${post.title}
                    ${
                      post.score > 0
                        ? `<span class="ml-2 text-xs sm:text-sm font-bold ${
                            post.score >= 10 ? "text-red-500" : "text-blue-500"
                          }">
                        +${post.score}
                      </span>`
                        : ""
                    }
                  </h3>
                  <div class="flex items-center space-x-2 sm:space-x-4 text-xs sm:text-sm text-gray-500">
                    <span><i class="far fa-eye"></i> ${post.views || 0}</span>
                    <span><i class="far fa-comment"></i> ${
                      post.comments?.length || 0
                    }</span>
                    <div class="flex items-center space-x-1">
                      <span class="text-blue-500"><i class="fas fa-arrow-up"></i> ${
                        post.upvotes
                      }</span>
                      <span class="text-red-500"><i class="fas fa-arrow-down"></i> ${
                        post.downvotes
                      }</span>
                    </div>
                  </div>
                </div>
                <div class="mt-1 sm:mt-2 text-xs sm:text-sm text-gray-600">
                  <span class="font-medium">${
                    post.author?.nickname || "익명"
                  }</span>
                  ${
                    post.ipAddress
                      ? `<span class="text-gray-400">(${post.ipAddress})</span>`
                      : ""
                  }
                  <span class="mx-2">|</span>
                  <span>${formatDate(post.createdAt)}</span>
                </div>
              </div>
            `
            )
            .join("");
        } else {
          postList.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              일반 게시글이 없습니다.
            </div>
          `;
        }

        // 페이지네이션 업데이트
        updatePagination(data.currentPage, data.totalPages);

        // 총시글 수 업데이트
        document.getElementById("totalPosts").textContent = data.totalPosts;
      }

      // 정렬 처리 함수
      async function handleSort(sortType) {
        try {
          const response = await fetch(
            `${API_BASE_URL}/api/posts?sort=${sortType}&page=${currentPage}&limit=${postsPerPage}`
          );

          if (!response.ok) {
            throw new Error("Failed to fetch sorted posts");
          }

          const data = await response.json();
          displayPosts(data);
          updatePagination(data.currentPage, data.totalPages);
        } catch (error) {
          console.error("정렬 처리 중 오류:", error);
          displayError("게시글 정렬을 처리하는데 실패했습니다.");
        }
      }

      // searchPosts 함수 수정
      async function searchPosts(searchQuery, searchType) {
        try {
          // 검색어가 비어있으면 전체 목록 표시
          if (!searchQuery.trim()) {
            return fetchPosts();
          }

          // 현재 표시된 게시글들 가져오기
          const postList = document.getElementById("postList");
          const bestPostsContainer = document.getElementById("bestPosts");

          // 게시글 필필터링 함수
          function filterPost(post, query, type) {
            query = query.toLowerCase();
            switch (type) {
              case "title":
                return post.title.toLowerCase().includes(query);
              case "content":
                return post.content.toLowerCase().includes(query);
              case "author":
                const authorName =
                  post.author?.nickname || post.anonymousNick || "익명";
                return authorName.toLowerCase().includes(query);
              default: // all (제목+내용)
                return (
                  post.title.toLowerCase().includes(query) ||
                  post.content.toLowerCase().includes(query)
                );
            }
          }

          // 전체 게시글 가져오기
          const response = await fetch(
            `${API_BASE_URL}/api/posts?page=1&limit=100`
          );

          if (!response.ok) {
            throw new Error("게시글을 불러오는데 실패했습니다.");
          }

          const data = await response.json();

          // 검색 조건에 맞는 시글 필터링
          const filteredBestPosts = data.bestPosts.filter((post) =>
            filterPost(post, searchQuery, searchType)
          );

          const filteredPosts = data.posts.filter((post) =>
            filterPost(post, searchQuery, searchType)
          );

          // 검색 결과 표시
          displayPosts({
            bestPosts: filteredBestPosts,
            posts: filteredPosts,
            currentPage: 1,
            totalPages: 1,
            totalPosts: filteredPosts.length,
          });

          // 검색 결과 표시
          const totalPosts = document.getElementById("totalPosts");
          totalPosts.textContent = `검색결과: ${filteredPosts.length}개`;
        } catch (error) {
          console.error("검색 중 오류:", error);
          displayError("검색 중 오류가 발생했습니다. 다시 시도해주세요.");
        }
      }

      // 검색 이벤트 리스너 수정
      document
        .getElementById("searchForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const searchQuery = document.getElementById("searchInput").value;
          const searchType = document.getElementById("searchType").value;
          await searchPosts(searchQuery, searchType);
        });

      // 에러 표표시 함수 수정
      function displayError(message) {
        const postList = document.getElementById("postList");
        postList.innerHTML = `
              <div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded">
                <p class="text-center">${message}</p>
              </div>
            `;
      }

      // 이전글/다음글 비게이션 업데이트
      function updateNavigation(firstPostId, lastPostId) {
        const prevBtn = document.getElementById("prevPost");
        const nextBtn = document.getElementById("nextPost");

        prevBtn.disabled = !firstPostId;
        nextBtn.disabled = !lastPostId;

        if (firstPostId) {
          prevBtn.onclick = () => fetchPosts({ before: firstPostId });
        }
        if (lastPostId) {
          nextBtn.onclick = () => fetchPosts({ after: lastPostId });
        }
      }

      // 글 작성 함수
      async function submitPost(e) {
        e.preventDefault();
        const title = document.getElementById("postTitle").value;
        const content = document.getElementById("postContent").value;
        const isAnonymous = document.getElementById("isAnonymous").checked;

        try {
          const response = await apiRequest("/api/posts", "POST", {
            title,
            content,
            board: "all",
            isAnonymous,
          });

          document.getElementById("writePostModal").classList.add("hidden");
          alert("게시글이 성적으로 작성되었습니다.");
          fetchPosts(); // 게시글 목록 새로고침
        } catch (error) {
          console.error("글 작성 중 오류 발생:", error);
          alert("글 작성 중 오류가 발생했습니다. 다시 시도해주세요.");
        }
      }

      // 댓글 작성 함수
      async function submitComment(postId, content, isAnonymous) {
        try {
          await apiRequest(`/api/posts/${postId}/comments`, "POST", {
            content,
            isAnonymous,
          });
          // 댓글 목록 새로고침 로직 추가
        } catch (error) {
          console.error("댓글 작성 중 오류 발생:", error);
        }
      }

      // 로그인 상태 확인 및 용자 정보 가져오기
      async function checkLoginStatus() {
        const token = localStorage.getItem("token");
        if (token) {
          try {
            const response = await apiRequest("/api/user");
            localStorage.setItem("user", JSON.stringify(response));
            if (response.isAdmin) {
              console.log("관리자로 로그인됨");
              // 여기에 관리자 UI 표시 로직 추가
            }
          } catch (error) {
            console.error("사용자 정보 가져오기 실패:", error);
            localStorage.removeItem("token");
            localStorage.removeItem("user");
          }
        }
      }

      // 이벤트 리스너 설정
      document.addEventListener("DOMContentLoaded", function () {
        // 기존의 searchForm 이벤트 리스너 제거
        const oldSearchFormListener = document
          .getElementById("searchForm")
          .querySelector("submit");
        if (oldSearchFormListener) {
          document
            .getElementById("searchForm")
            .removeEventListener("submit", oldSearchFormListener);
        }

        // 나머지 이벤트 리스너들...
      });

      // 페이지 로드드 시 실행
      window.onload = function () {
        checkLoginStatus();
        fetchPosts();
      };

      // 글쓰기 버튼 클릭 이벤트 핸들러 추가
      document
        .getElementById("writePostBtn")
        .addEventListener("click", function () {
          // 로그인 상태 확인
          const token = localStorage.getItem("token");

          if (!token) {
            // 비로그인 사용자는 write-post.html로 직접 이동
            window.location.href = "write-post.html";
          } else {
            // 로그인 사용자도 write-post.html로 이동
            window.location.href = "write-post.html";
          }
        });
    </script>
  </body>
</html>
